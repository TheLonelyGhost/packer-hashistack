{
  "variables": {
    "consul_template_version": "0.25.1",
    "envconsul_version": "0.10.0",
    "cni_plugins_version": "0.8.6",
    "linode_api_key": "{{ env `LINODE_API_KEY` }}",
    "do_api_key": "{{ env `DIGITAL_OCEAN_API_KEY` }}",
    "ssh_port": "{{ env `SSH_PORT` }}",
    "entry_username": "{{ env `SSH_USER` }}",
    "entry_user_pubkey": "{{ env `PUBKEY` }}"
  },
  "sensitive-variables": ["entry_username", "ssh_port", "linode_api_key"],
  "builders": [
    {
      "type": "linode",
      "name": "linode",
      "linode_token": "{{ user `linode_api_key` }}",
      "image": "linode/centos8",
      "region": "us-east",
      "instance_type": "g6-nanode-1",
      "instance_label": "temp-packer-{{ timestamp }}",
      "instance_tags": ["packer", "delete-me-if-older-than-4-hours"],

      "image_label": "hashistack-simple-{{ timestamp }}",
      "image_description": "Nomad, Consul, and Vault with helpers: Envoy, Docker, envconsul (v{{ user `envconsul_version` }}), and consul-template (v{{ user `consul_template_version` }})",

      "ssh_username": "root"
    },
    {
      "type": "digitalocean",
      "name": "do",
      "api_token": "{{ user `do_api_key` }}",
      "image": "centos-8-x64",
      "region": "nyc1",
      "size": "s-1vcpu-1gb",
      "droplet_name": "temp-packer-{{ timestamp }}",
      "tags": ["packer", "delete-me-if-older-than-4-hours"],

      "snapshot_name": "hashistack-simple-{{ timestamp }}",
      "snapshot_regions": ["nyc1", "nyc2", "nyc3"],

      "ssh_username": "root"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "{{ template_dir }}/firewalld",
      "destination": "/tmp"
    },
    {
      "type": "file",
      "source": "{{ template_dir }}/systemd",
      "destination": "/tmp/systemd"
    },
    {
      "type": "shell",
      "script": "{{ template_dir }}/scripts/base.sh",
      "environment_vars": [
        "ENTRY_USER={{ user `entry_username` }}",
        "ENTRY_USER_PUBKEY={{ user `entry_user_pubkey` }}",
        "SSH_PORT={{ user `ssh_port` }}"
      ]
    },
    {
      "type": "shell",
      "script": "{{ template_dir }}/scripts/install-hashistack.sh",
      "environment_vars": [
        "ENVCONSUL_VERSION={{ user `envconsul_version` }}",
        "CONSUL_TEMPLATE_VERSION={{ user `consul_template_version` }}",
        "CNI_PLUGINS_VERSION={{ user `cni_plugins_version` }}"
      ]
    },
    {
      "type": "file",
      "source": "{{ template_dir }}/consul-template",
      "destination": "/etc/consul-template"
    },
    {
      "type": "file",
      "source": "{{ template_dir }}/post-hoc",
      "destination": "/opt/first-run"
    },
    {
      "type": "shell",
      "scripts": ["{{ template_dir }}/scripts/cleanup.sh"],
      "override": {
        "linode": {
          "scripts": [
            "{{ template_dir }}/scripts/linode.sh",
            "{{ template_dir }}/scripts/cleanup.sh"
          ]
        },
        "do": {
          "scripts": [
            "{{ template_dir }}/scripts/digitalocean.sh",
            "{{ template_dir }}/scripts/cleanup.sh"
          ]
        }
      }
    }
  ]
}
